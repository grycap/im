---
openapi: 3.1.0
components:
  schemas:
    Date:
      type: string
      format: date
      examples: 
        - value: 2025-02-17
    Version:
      type: string
    Success:
      type: object
      properties:
        message:
          type:
          - string
          - "null"
          description: Confirmation message
    Error:
      type: object
      properties:
        id:
          type: string
          description: Error type
        description:
          type:
          - string
          - "null"
          description: Error message
        details:
          type:
          - object
          - "null"
          additionalProperties:
            type: string
          description: Additional details about the error
    CredentialsOpenStack:
      type: object
      required:
        - kind
        - host
        - authVersion
      properties:
        kind:
          type: string
          default: CredentialsOpenStack
        userName:
          type: string
        domain:
          type: string
          format: hostname
        domainId:
          type: string
        tenant:
          type: string
        tenantId:
          type: string
        region:
          type: string
        host:
          type: string
          format: url
        authVersion:
          type: string
          enum:
            - "3.x-oidc"
        apiVersion:
          type: string
    CredentialsKubernetes:
      type: object
      required:
        - kind
        - host
      properties:
        kind:
          type: string
          default: CredentialsKubernetes
        host:
          type: string
          format: url
    Credentials:
      oneOf:
        - $ref: "#/components/schemas/CredentialsOpenStack"
        - $ref: "#/components/schemas/CredentialsKubernetes"
      discriminator:
        propertyName: kind
    EoscNodeEnvironment:
      type: object
      required:
        - offer
        - nodeName
        - awmApi
      properties:
        kind:
          type: string
          default: EoscNodeAllocation
        offer:
          type: object
          required:
            - offerId
            - offerType
          properties:
            offerId:
              type: string
            offerName:
              type: string
            offerType:
              type: string
              enum:
                - openstack
                - kubernetes
            cpus:
              type: integer
              minimum: 1
            gpus:
              type: integer
            memory:
              type: integer
              minimum: 1
              description: RAM quota in GB
            fastStorage:
              type: integer
              description: SSD or NVMe based (fast) storage quota in GB
            bulkStorage:
              type: integer
              description: HDD based (slow) storage quota in GB
            s3Storage:
              type: integer
              description: S3 storage quota in GB
            registryStorage:
              type: integer
              description: Container Registry storage quota in GB
            creditsPerDay:
              type: integer
              minimum: 1
        projectId:
          type: string
        hostname:
          type: string
          format: url
        provisionedOn:
          type: string
          format: date-time
          examples:
            - value: 2025-02-17T14:27:01.000+0100
        expiresOn:
          type: string
          format: date-time
          examples:
            - value: 2025-02-17T14:27:01.000+0100
        nodeName:
          type: string
          description: Name of the EOSC node where this environment was allocated
        nodeUI:
          type: string
          format: url
          description: URL to the interactive UI of the EOSC node where this environment was allocated
        awmAPI:
          type: string
          format: url
          description: |-
            Base URL for the AWM API of the EOSC node where this environment was allocated, 
            or null for environments private to the calling user that accessed via 
            explicit credentials
    AllocationId:
      type: object
      required:
        - kind
        - id
      properties:
        kind:
          type: string
          default: AllocationId
        id:
          type: string
          description: Unique identifier for this allocation
        self:
          type: string
          format: url
          description: Endpoint that returns more details about this entity
    Allocation:
      oneOf:
        - $ref: "#/components/schemas/EoscNodeEnvironment"
        - $ref: "#/components/schemas/CredentialsOpenStack"
        - $ref: "#/components/schemas/CredentialsKubernetes"
      discriminator:
        propertyName: kind
    AllocationInfo:
      allOf:
        - $ref: "#/components/schemas/Allocation"
        - type: object
          required:
            - id
          properties:
            id:
              type: string
            self:
              type: string
              format: url
              description: Endpoint that returns the details of this allocation
    ToolId:
      type: object
      required:
        - id
      properties:
        kind:
          type: string
          default: ToolId
        id:
          type: string
          description: Unique identifier for this tool blueprint
        infoLink:
          type: string
          format: url
          description: URL that returns the full details of this tool blueprint
    ToolInfo:
      type: object
      required:
        - type
        - blueprint
        - blueprintType
      properties:
        kind:
          type: string
          default: ToolInfo
        id:
          type: string
          description: Unique identifier for this tool blueprint
        type:
          type: string
          enum:
            - vm
            - container
        blueprint:
          type: string
          description: Blueprint of the tool's workload
        blueprintType:
          type: string
          enum:
            - tosca
            - ansible
            - helm
          default: tosca
        name:
          type: string
        description:
          type: string
        authorName:
          type: string
        authorEmail:
          type: string
          format: email
        organisation:
          type: string
        keywords:
          type: array
          items: 
            type: string
        license:
          type: string
        version:
          type: string
        versionFrom:
          type: string
          format: date-time
          examples:
            - value: 2025-02-17T14:27:01.000+0100
        repository:
          type: string
          format: url
        helpdesk:
          type: string
          format: url
        validated:
          type: boolean
        validatedOn:
          type: string
          format: date-time
          examples:
            - value: 2025-02-17T14:27:01.000+0100
        self:
          type: string
          format: url
          description: Endpoint that returns the details of this tool blueprint
    Tool:
      oneOf:
        - $ref: "#/components/schemas/ToolId"
        - $ref: "#/components/schemas/ToolInfo"
      discriminator:
        propertyName: kind
    DeploymentId:
      type: object
      required:
        - kind
        - id
      properties:
        kind:
          type: string
          default: DeploymentId
        id:
          type: string
          description: Unique identifier for this deployment
        self:
          type: string
          format: url
          description: Endpoint that returns more details about this entity
    Deployment:
      type: object
      required:
        - tool
        - allocation
      properties:
        tool:
          $ref: "#/components/schemas/Tool"
          description: What to deploy
        allocation:
          $ref: "#/components/schemas/Allocation"
          description: Where to deploy it
    DeploymentInfo:
      allOf:
        - $ref: "#/components/schemas/Deployment"
        - type: object
          required:
            - id
          properties:
            id:
              type: string
            status:
              type: string
              enum:
                - unknown
                - pending
                - running
                - stopped
                - off
                - failed
                - configured
                - unconfigured
                - deleting
            self:
              type: string
              format: url
              description: Endpoint that returns the details of this deployment
    Page:
      type: object
      required:
        - from
        - limit
        - count
      properties:
        from:
          type: integer
          description: Index of the first returned element
        limit:
          type: integer
          description: Maximum number of elements to return at once
        count:
          type: integer
          description: Total number of elements
        self:
          type: string
          format: url
          description: Endpoint that returned this page
        prevPage:
          type: string
          format: url
          description: Endpoint that returns the previous page
        nextPage:
          type: string
          format: url
          description: Endpoint that returns the next page
    PageOfAllocations:
      allOf:
        - $ref: "#/components/schemas/Page"
        - type: object
          required:
            - elements
          properties:
            elements:
              type: array
              items:
                $ref: "#/components/schemas/AllocationInfo"
    PageOfTools:
      allOf:
        - $ref: "#/components/schemas/Page"
        - type: object
          required:
            - elements
          properties:
            elements:
              type: array
              items:
                $ref: "#/components/schemas/ToolInfo"
    PageOfDeployments:
      allOf:
        - $ref: "#/components/schemas/Page"
        - type: object
          required:
            - elements
          properties:
            elements:
              type: array
              items:
                $ref: "#/components/schemas/DeploymentInfo"
    UserInfo:
      type: object
      properties:
        kind:
          type: string
        base_id:
          type: string
        user_dn:
          type: string
        delegation_id:
          type: string
        dn:
          type: array
          items:
            type: string
        vos:
          type: array
          items:
            type: string
          description: Virtual organisation name(s)
        vos_id:
          type: array
          items:
            type: string
          description: Virtual organisation identifier(s)
        voms_cred:
          type: array
          items:
            type: string
  securitySchemes:
    OIDC:
      description: OpenID Connect access token issued by EOSC AAI
      type: http
      scheme: bearer
      bearerFormat: JWT
paths:
  /allocations:
    get:
      summary: List all credentials or EOSC environments of the user
      operationId: listAllocations
      parameters:
      - name: from
        description: Index of the first element to return
        in: query
        schema:
          type: integer
          minimum: 0
          default: 0
      - name: limit
        description: Maximum number of elements to return
        in: query
        schema:
          type: integer
          minimum: 1
          default: 100
      - name: allNodes
        in: query
        required: true
        schema:
          type: boolean
          default: false
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PageOfAllocations"
        400:
          description: Invalid parameters or configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        403:
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        419:
          description: Re-delegate credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        503:
          description: Try again later
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - OIDC: []
      tags:
        - Allocations

    post:
      summary: Record credentials or EOSC environment of the user
      operationId: recordAllocation
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Allocation"
        required: true
      responses:
        201:
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AllocationId"
        400:
          description: Invalid parameters or configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        403:
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        419:
          description: Re-delegate credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        503:
          description: Try again later
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - OIDC: []
      tags:
        - Allocations

  /allocation/{allocationId}:
    parameters:
      - name: allocationId
        in: path
        required: true
        schema:
          type: string
  
    get:
      summary: Retrieve information about existing credentials or EOSC environment of the user
      operationId: getAllocationInfo
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AllocationInfo"
        400:
          description: Invalid parameters or configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        403:
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        404:
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        419:
          description: Re-delegate credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        503:
          description: Try again later
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - OIDC: []
      tags:
        - Allocations

    put:
      summary: Update existing credentials or EOSC environment of the user
      operationId: updateAllocation
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Allocation"
        required: true
      responses:
        200:
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AllocationInfo"
        400:
          description: Invalid parameters or configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        403:
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        404:
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        419:
          description: Re-delegate credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        503:
          description: Try again later
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - OIDC: []
      tags:
        - Allocations

    delete:
      summary: Delete existing credentials or EOSC environment of the user
      operationId: deleteAllocation
      responses:
        200:
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"
        400:
          description: Invalid parameters or configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        403:
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        404:
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        419:
          description: Re-delegate credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        503:
          description: Try again later
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - OIDC: []
      tags:
        - Allocations 

  /tools:
    get:
      summary: List all tool blueprints
      operationId: listTools
      parameters:
      - name: from
        description: Index of the first element to return
        in: query
        schema:
          type: integer
          minimum: 0
          default: 0
      - name: limit
        description: Maximum number of elements to return
        in: query
        schema:
          type: integer
          minimum: 1
          default: 100
      - name: allNodes
        in: query
        required: true
        schema:
          type: boolean
          default: false
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PageOfTools"
        400:
          description: Invalid parameters or configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        403:
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        419:
          description: Re-delegate credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        503:
          description: Try again later
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - OIDC: []
      tags:
        - Tools

  /tool/{toolId}:
    parameters:
      - name: toolId
        in: path
        required: true
        schema:
          type: string

    get:
      summary: Get information about a tool blueprint
      operationId: getTool
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ToolInfo"
        400:
          description: Invalid parameters or configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        403:
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        404:
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        419:
          description: Re-delegate credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        503:
          description: Try again later
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - OIDC: []
      tags:
        - Tools

  /deployments:
    get:
      summary: List existing deployments
      operationId: listDeployments
      parameters:
      - name: from
        description: Index of the first element to return
        in: query
        schema:
          type: integer
          minimum: 0
          default: 0
      - name: limit
        description: Maximum number of elements to return
        in: query
        schema:
          type: integer
          minimum: 1
          default: 100
      - name: allNodes
        in: query
        required: true
        schema:
          type: boolean
          default: false
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PageOfDeployments"
        400:
          description: Invalid parameters or configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        403:
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        419:
          description: Re-delegate credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        503:
          description: Try again later
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - OIDC: []
      tags:
        - Deployments
    post:
      summary: |
        Deploy workload to an EOSC environment or an infrastructure for which
        the user has credentials
      operationId: deployWorkload
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Deployment"
        required: true
      responses:
        204:
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeploymentId"
        400:
          description: Invalid parameters or configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        403:
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        419:
          description: Re-delegate credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        503:
          description: Try again later
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - OIDC: []
      tags:
        - Deployments
    
  /deployment/{deploymentId}:
    parameters:
      - name: deploymentId
        in: path
        required: true
        schema:
          type: string

    get:
      summary: Get information about an existing deployment
      operationId: getDeployment
      responses:
        200:
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeploymentInfo"
        400:
          description: Invalid parameters or configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        403:
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        404:
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        419:
          description: Re-delegate credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        503:
          description: Try again later
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - OIDC: []
      tags:
        - Deployments
    delete:
      summary: Tear down an existing deployment
      operationId: deleteDeployment
      responses:
        204:
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"
        400:
          description: Invalid parameters or configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        403:
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        404:
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        419:
          description: Re-delegate credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        503:
          description: Try again later
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - OIDC: []
      tags:
        - Deployments

  /user/info:
    get:
      summary: Retrieve information about the user
      operationId: getUserInfo
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserInfo"
        400:
          description: Invalid parameters or configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Authorization required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        403:
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        419:
          description: Re-delegate credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        503:
          description: Try again later
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - OIDC: []
      tags:
        - Users

  /version:
    get:
      summary: Return service version information
      operationId: version
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Version"
      tags:
        - Service
info:
  title: EOSC Application Workflow Management API
  version: 0.1.20
  description: Deployment service for European Open Science Cloud nodes
  contact:
    name: EOSC
    url: https://open-science-cloud.ec.europa.eu/
  license:
    name: Apache 2.0
    url: http://www.apache.org/licenses/LICENSE-2.0.html
